<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RMACC Zwift Club</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="rmacc-192.png" type="image/png">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: white;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }

    header {
      width: 100%;
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }

    header img {
      height: 60px;
      margin-right: 1rem;
    }

    h1 {
      color: green;
      font-size: 2rem;
      margin: 0;
    }

    h2 {
      color: orange;
      font-size: 0.95rem;
      margin: 0;
      line-height: 1.2;
    }

    /* Green button */
    .rules-btn {
      background-color: green;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      margin: 1rem 0;
      cursor: pointer;
      transition: background 0.2s;
    }
    .rules-btn:hover {
      background-color: #006400; /* darker green */
    }

    /* Table */
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 800px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    tr:nth-child(odd) {
      background-color: #f9f9f9;
    }
    .table-container {
      overflow-x: auto;
      width: 100%;
    }

    /* Highlight rows */
    .gold { background-color: #ffd700 !important; font-weight: bold; }
    .silver { background-color: #c0c0c0 !important; font-weight: bold; }
    .bronze { background-color: #cd7f32 !important; font-weight: bold; }
    .cup-icon { margin-right: 0.4rem; font-size: 1.2rem; }
    .nowrap { white-space: nowrap; display: inline-block; }

    /* Alerts */
    .alert {
      position: relative;
      padding: 0.75rem 2rem 0.75rem 1rem;
      margin: 1rem 0;
      border-radius: 0.5rem;
      font-weight: bold;
    }
    .alert.offline {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    .alert.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .alert .close-btn {
      position: absolute;
      top: 0.25rem;
      right: 0.5rem;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      color: inherit;
      background: none;
      border: none;
    }

    /* Modal (popup) */
    .modal {
      display: none; /* hidden by default */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 1rem;
      max-width: 600px;
      width: 90%;
      border-radius: 8px;
      text-align: left;
      position: relative;

      /* NEW: make modal scrollable if content is long */
      max-height: 80vh;    /* take up at most 80% of viewport height */
      overflow-y: auto;    /* scroll inside the modal if too tall */
    }
    .modal-content h3 {
      margin-top: 0;
      color: green;
    }
    .modal-close {
      background: green;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      margin-top: 1rem;
      float: right;
    }
    .modal-close:hover {
      background: #006400;
    }
  </style>
</head>
<body>
  <header>
    <img src="rmacc-512.png" alt="RMACC Logo">
    <div>
      <h1>RMACC Zwift Club</h1>
      <h2>Legends of Zwift Winter Series 2025/26</h2>
    </div>
  </header>

  <!-- New Rules button -->
  <button class="rules-btn" id="rulesBtn">Rules &amp; points</button>

  <!-- Modal structure -->
  <div class="modal" id="rulesModal">
    <div class="modal-content">
      <h3>Rules &amp; Points</h3>
      <p>
        <!-- Replace this text with your real rules -->
        Add the details of the competition rules, points system,
        and any other information for riders. If the text is long, this area
        will scroll while keeping the modal within the screen.
      </p>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur eget varius libero. Suspendisse potenti. Mauris malesuada, lorem quis hendrerit volutpat, magna sapien sodales eros, eget faucibus est sapien vitae nunc.</p>
      <p>Aliquam erat volutpat. Quisque vehicula odio at lorem faucibus, vel ultrices mi tincidunt. Nulla vel luctus mi, et sagittis eros. Phasellus semper lacus nec nunc viverra, nec interdum nulla malesuada.</p>
      <p>... (add as much as you need, this area will scroll internally) ...</p>

      <button class="modal-close" id="closeModal">Close</button>
    </div>
  </div>

  <div class="table-container">
    <table id="league-table">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSVnw2KKM6Nq2GdqNgQsDB6kt_pEKW5wzPXg_hyljv7At5-mhVULozttX6BDj98EQ/pub?gid=1326660133&single=true&output=csv";

    async function fetchCSV(url) {
      try {
        const res = await fetch(url);
        const text = await res.text();
        return { text, offline: false };
      } catch (err) {
        const cache = await caches.open("zwift-cache-v3");
        const cachedResponse = await cache.match(url);
        if (cachedResponse) {
          const text = await cachedResponse.text();
          return { text, offline: true };
        } else {
          throw new Error("No cached data");
        }
      }
    }

    function parseCSV(text) {
      return text.trim().split(/\r?\n/).map(r => r.split(","));
    }

    function renderTable(data) {
      const table = document.getElementById("league-table");
      const thead = table.querySelector("thead");
      const tbody = table.querySelector("tbody");
      thead.innerHTML = "";
      tbody.innerHTML = "";

      const headerRow = document.createElement("tr");
      data[0].forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      let rows = data.slice(1);
      const pointsIndex = data[0].findIndex(h => /points/i.test(h));
      if (pointsIndex >= 0) {
        rows.sort((a, b) => parseInt(b[pointsIndex]) - parseInt(a[pointsIndex]));
      }

      rows.forEach((row, i) => {
        const tr = document.createElement("tr");
        row.forEach(cell => {
          const td = document.createElement("td");
          td.textContent = cell;
          tr.appendChild(td);
        });

        if (i === 0) {
          tr.classList.add("gold");
          tr.firstChild.innerHTML = '<span class="nowrap"><span class="cup-icon">üèÜ</span>' + tr.firstChild.textContent + '</span>';
        } else if (i === 1) {
          tr.classList.add("silver");
          tr.firstChild.innerHTML = '<span class="nowrap"><span class="cup-icon">ü•à</span>' + tr.firstChild.textContent + '</span>';
        } else if (i === 2) {
          tr.classList.add("bronze");
          tr.firstChild.innerHTML = '<span class="nowrap"><span class="cup-icon">ü•â</span>' + tr.firstChild.textContent + '</span>';
        }

        tbody.appendChild(tr);
      });
    }

    function showMessage(msg, type = "error") {
      const container = document.querySelector(".table-container");
      container.querySelectorAll(".alert").forEach(el => el.remove());
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("alert", type);
      const textSpan = document.createElement("span");
      textSpan.textContent = msg;
      const closeBtn = document.createElement("button");
      closeBtn.classList.add("close-btn");
      closeBtn.innerHTML = "‚úñ";
      closeBtn.onclick = () => msgDiv.remove();
      msgDiv.appendChild(textSpan);
      msgDiv.appendChild(closeBtn);
      container.prepend(msgDiv);
    }

    fetchCSV(CSV_URL)
      .then(({ text, offline }) => {
        renderTable(parseCSV(text));
        if (offline) showMessage("‚ö†Ô∏è Offline mode: showing last saved table.", "offline");
      })
      .catch(() => {
        showMessage("‚ùå No data available. Please connect to the internet.", "error");
      });

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }

    // Modal logic
    const modal = document.getElementById("rulesModal");
    const btn = document.getElementById("rulesBtn");
    const closeBtn = document.getElementById("closeModal");

    btn.onclick = () => { modal.style.display = "flex"; };
    closeBtn.onclick = () => { modal.style.display = "none"; };
    window.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; };
  </script>
</body>
</html>

